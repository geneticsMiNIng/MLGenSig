---
title: "Vignette Title"
author: "Aleksandra Dąbrowska, Alicja Gosiewska"
date: "`r Sys.Date()`"
toc: yes
output: pdf_document
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Package (Abstract?)
It is considered that the result of increased methylation is decreased gene expression. While, recent studies suggest that the relationship between methylation and expression is more complex than was previously thought.
The package ... provides methods to test for differential expression and methylation by use of the negative binonial distribution and t-test. Additionaly package ... allows to visualize results in a simple way.

# Standard Workflow

In this vignette we will work with the data sets containing information about gene expression and methylation for patients with breast cancer. We will analyze differences in methylation and expression for patients with different subtypes of BRCA cancer.

## Function test_diff

The main function of the package is `test_diff`. It allows to find differences between genes methylation or expression, taking into account additional information about samples.

### Methylation

Methylation is a process by which methyl groups are added to the DNA molecule. It can change the activity of a DNA without changing the sequence. DNA methylation typically acts to repress gene transcription. But there exist situations in which adding the methyl groups intensify it.
DNA methylation is associated with a lots of key processes including genomic imprinting, repression of transposable elements, aging and carcinogenesis.
In our work we want to bind methylation process and carcinogenesis.

#### `BRCA_methylation_chr17` data set
In this section, we will work with the methylation level data from TCGA database. 
Package contains `BRCA_methylation_chr17` dataset. `BRCA_methylation_chr17` contains information about methylation of CpG islands located on 17th chromosome for patienst with breast cancer. 
Rows of this data set correspond to patients, more precisely, to samples taken from patients.
First column `SUBTYPE`corresponds to a subtype of BRCA cancer, next columns correspond to CpG islands.
Values inside the table indicate the methylation level of CpG island for specified sample.
```{r}
library(MetExpR)
head(BRCA_methylation_chr17)[1:5,1:4]
```

#### Data preparation

In this analysis we would like to find genes with different methylation level. At first we need to use function `map_to_gene`, which generates new data frame with CpG islands mapped to genes.

```{r mapping}
BRCA_methylation_chr17_gen <- map_to_gene(BRCA_methylation_chr17[,-1]) 
head(BRCA_methylation_chr17_gen)[1:5,1:4]
```

Function `test_diff` allows us to test for differences between the base means for two or more conditions. 

In this case we have two conditions, connected with subtypes of breast cancer.

Before we go to the testing, we need to define condition values for each sample. We would like to test for differences between `LumA` subtype and `other` subtypes of breast cancer, so we create vector, which each element corresponds to a sample. Our division into this two group relies on numbers of occurences of each subtype. The `LumA` subtype is the most common, in case of breast cancer.

```{r}
condition <- ifelse(BRCA_methylation_chr17$SUBTYPE=="LumA","LumA", "other")
head(condition,8)
```

#### T-test

One of the most used tools for testing differences between values is t-test. The null hypothesis we have consider, is that means in two groups are equal.
To use it in `test_diff` function, we set value of parameter `test` on "ttest".

```{r}
test.mety <- test_diff(BRCA_methylation_chr17_gen, condition, test="ttest")
```

As a result we obtain a data frame with columns corresponds to: id of gene, mean, logarithm of fold change, p-value for t-test, adjusted p-value (BH method). For more information about customizing this function see the help page for `test_diff`.

```{r}
head(test.mety)
```

### Expression 

Gene expression is the process by which information from a gene is used in the synthesis of proteins. The process of gene expression is used by all known life.

#### `BRCA_mRNAseq_chr17` data set

In this section we will use data set `BRCA_mRNAseq_chr17`, which contains information about gene expression.
This data set contains per-gene read counts computed for genes from 17th chromosome for 100 patients with breast cancer.
Rows of this data set correspond to samples taken from patients.
First column `SUBTYPE`corresponds to a subtype of BRCA cancer, next columns correspond to genes.

```{r}
BRCA_mRNAseq_chr17[1:5,1:5]
```

#### Negative binomial test
Negative binomial test, which uses negative binomial distribution is an another tool for finding differencial expression between our conditions. 

As in the t-test we also need a description of the samples, which we keep in a vector, whose elements correspond to different gorups.

In our example we will test for differential expression between groups with LumA breast cancer subtype and other subtypes of that cancer.
Again we will use vector `conditions`, which consist of two values corresponds to subtype of breast cancer: LumA and other.
```{r, message=FALSE}
condition<-ifelse(BRCA_mRNAseq_chr17$SUBTYPE=="LumA","LumA","other")
head(condition,8)
```

```{r, echo=FALSE}
load("testexpr.rda")
```

For using negative binomial test, in function `test_diff` we set value "nbinom" for parameter `test`.
Evaluation for nbinorm may take a few minutes.
```{r,eval=FALSE}
test.expr <- test_diff(BRCA_mRNAseq_chr17[,-1], condition, test="nbinom")
```

As a result we obtain the following data frame:

```{r}
head(test.expr)
```

# Visualization

## em_plot
```{r}
em_plot(BRCA_mRNAseq_chr17[,-1], condition, names=5)
```

## log-log p-value

Firstly, we want to visualise the p-values for expression and methylation from negative binomial test and t-test respectively.

```{r p_values_plot}
p_values_plot(test.expr, test.mety)
```

Additionally, `names` parameter allows to mark genes with sum of p-values for methylation and expression, lower than given value. Value of parameter `names` defines, number of genes to label.
```{r p_values_plot2}
p_values_plot(test.expr, test.mety, names = 5)
``` 

To read more about `p_values_plot` (e.g other ways to labeling genes) see help page for that function.

## Volcano plot

For identify changes in our data sets we use a volcano plot - some type of scatter-plot.
It plots logarithm of p-value versus logarithm of fold-change on the y and x axes, respectively. 

```{r}
volcano_plot(test.expr)
```

Function `volcano_plot` has parameters that allow to better analyze the results: `line` and `names`. The `line` parameter allows to set the horizontal line on plot on selected value. The `names` parameter signs choosen number of genes with the lowest p-value.

```{r}
volcano_plot(test.expr, line = 0.05)
volcano_plot(test.expr, names = 10)
```


## Methylation and expression for one gene.

In the end we want to present the distribution of methylation and expression for choosen genes.

```{r, include=FALSE}
# Warning in install.packages :
#   package ‘easyGgplot2’ is not available (for R version 3.3.3)

#library(easyGgplot2)
#p1 <-genereg_vs_met(BRCA_methylation_chr17, "BRCA1")
#p2 <-boxplot_gene_expr(BRCA_mRNAseq_chr17,"BRCA1")
#ggplot2.multiplot(p1,p2)

```

Function `CpG_mean` computes methylation means of CpG islands for choosen gene. In this case: "BRCA1"

```{r}
BRCA1_gene <- CpG_mean(BRCA_methylation_chr17, "BRCA1")
head(BRCA1_gene)
```

First we visualize the mean value of methylation for each CpG island on this gene using function `genereg_vs_met`.

```{r}
genereg_vs_met(BRCA_methylation_chr17, "BRCA1")
```

Same point color means that each probe has the same address.

With function `boxplot_gene_expr`, we consider the distribution of expression from 100 probes.

```{r}
boxplot_gene_expr(BRCA_mRNAseq_chr17,"BRCA1")
```

It is easy to set both plots together.
```{r}
library(gridExtra)
library(ggplot2)
g <- genereg_vs_met(BRCA_methylation_chr17, "BRCA1") 
b <- boxplot_gene_expr(BRCA_mRNAseq_chr17,"BRCA1")

grid.arrange(g,b, ncol = 1, 
             layout_matrix = t(as.matrix(c(1,1,1,2))))
```



###Methylation and expression in groups.

For both groups `LumA` and `other` we want to visualise distribution of methylation and expression. First plot describes data from `LumA` group, second from `other` group.

```{r, include=FALSE}
BRCA_methylation_chr17_LumA <- BRCA_methylation_chr17[which(BRCA_methylation_chr17$SUBTYPE=="LumA"),]

BRCA_methylation_chr17_other <- BRCA_methylation_chr17[which(BRCA_methylation_chr17$SUBTYPE!="LumA"),]

```

```{r}
lum <- genereg_vs_met(BRCA_methylation_chr17_LumA, "BRCA1")
other <- genereg_vs_met(BRCA_methylation_chr17_other, "BRCA1")

grid.arrange(lum,other, ncol = 1, 
             layout_matrix = t(as.matrix(c(1,1,2,2))))

```


```{r, include=FALSE}

BRCA_mRNAseq_chr17_LumA <- BRCA_mRNAseq_chr17[which(BRCA_mRNAseq_chr17$SUBTYPE=="LumA"),]

BRCA_mRNAseq_chr17_other <- BRCA_mRNAseq_chr17[which(BRCA_mRNAseq_chr17$SUBTYPE!="LumA"),]

```


Two subtype groups of cancer in one plot.
```{r}
genereg_vs_met2(BRCA_methylation_chr17, condition, "BRCA1")


```



